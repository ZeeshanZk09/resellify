// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
    provider = "prisma-client"
    output   = "../src/shared/lib/generated/prisma"
}

datasource db {
    provider = "postgresql"
}

// ---------------------------------------------------
//                   Enums 
// ---------------------------------------------------

enum ProductStatus {
    DRAFT
    PUBLISHED
    ARCHIVED
    SCHEDULED
}

enum Visibility {
    PUBLIC
    PRIVATE
    UNLISTED
}

enum TwitterCard {
    SUMMARY
    SUMMARY_LARGE_IMAGE
    APP
    PLAYER
}

enum OrderStatus {
    CREATED // placed by user (for COD) or after payment pending confirmation
    PENDING // waiting for admin confirmation / validation (e.g. you call user)
    CONFIRMED // admin confirmed that order should be processed
    PROCESSING // preparing / packing
    SHIPPED
    DELIVERED
    CANCELLED
    RETURNED
    REFUNDED
}

enum PaymentMethod {
    JAZZCASH
    COD
}

enum PaymentStatus {
    PENDING
    SUCCEEDED
    FAILED
    REFUNDED
}

enum CouponType {
    PERCENT
    FIXED
}

enum Role {
    USER
    ADMIN
    SUPPORT
}

// Enums
enum OptionType {
    TEXT // simple text options (e.g., "Cotton", "Polyester")
    COLOR // color options (render as swatch, value can be hex)
    NUMBER // numeric option (e.g., diopter for glasses)
    SIZE // size labels (S, M, L, 1-2yrs, 3-5yrs)
    MEASURE // measured sizes (e.g., waist in inches, length in cm)
    RANGE // range-based (e.g., 30-32)
    BOOLEAN // yes/no like "Adjustable"
}

enum OrderStatus {
    PENDING
    CONFIRMED
    PLACED // tum ne markaz pr jaa ke order place kia (physical)
    SHIPPED
    DELIVERED
    CANCELLED
}

enum DiscountType {
    PERCENT
    FLAT
}

enum OfferTarget {
    ALL_PRODUCTS
    CATEGORY
    PRODUCT
}

// ---------------------------------------------------
//                   User Management
// ---------------------------------------------------

model User {
    id            String    @id @default(cuid())
    name          String
    email         String    @unique
    emailVerified DateTime?
    password      String
    phoneNumber   String?   @unique

    // roles & status
    role      Role    @default(USER)
    isActive  Boolean @default(true) // admin can deactivate
    isBlocked Boolean @default(false) // admin block

    // Membership / plus user
    isPlusMember Boolean   @default(false)
    plusUntil    DateTime? // expiry for plus benefits (free shipping etc.)

    // Relations
    publishedProducts Product[] @relation("ProductPublisher")
    publishedBrands   Brand[]   @relation("BrandPublisher")

    // explicit favorite join (better than implicit many-to-many)
    favourites Favourite[]

    // addresses, cart, orders, sessions/accounts
    addresses Address[]
    carts     Cart[]
    orders    Order[]
    reviews   Review[]
    sessions  Session[]

    // analytics
    visits Visit[]

    orderLogs         OrderLog[]
    couponRedemptions CouponRedemption[]
    waitlists         Waitlist[]
    auditLogs         AuditLog[]
    createdBrands     Brand[]            @relation("BrandCreatedBy")
    createdProducts   Product[]          @relation("ProductUploader")

    createdAt DateTime  @default(now())
    updatedAt DateTime? @updatedAt
}

model Session {
    id           String    @id @default(cuid())
    sessionToken String    @unique
    userId       String
    isExpired    Boolean   @default(false)
    expires      DateTime?

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
    id         String   @id @default(cuid())
    identifier String   @unique
    token      String   @unique
    expires    DateTime

    @@unique([identifier, token])
}

model Address {
    id         String  @id @default(cuid())
    userId     String
    label      String? // "Home", "Office"
    fullName   String
    phone      String
    line1      String
    line2      String?
    city       String
    state      String?
    postalCode String?
    country    String  @default("Pakistan")
    isDefault  Boolean @default(false)

    user User @relation(fields: [userId], references: [id], onDelete: Cascade)

    createdAt DateTime  @default(now())
    updatedAt DateTime? @updatedAt
    orders    Order[]

    @@index([userId])
}

// ---------------------------------------------------
//                   Products/store management
// ---------------------------------------------------

model Favourite {
    id        String   @id @default(cuid())
    userId    String
    productId String
    createdAt DateTime @default(now())

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@unique([userId, productId])
    @@index([productId])
}

model Product {
    id               String        @id @default(cuid())
    name             String
    description      String? // long description / HTML or markdown
    shortDescription String?
    slug             String        @unique
    sku              String?       @unique
    price            Decimal?
    currency         String?       @default("PKR")
    status           ProductStatus @default(DRAFT)
    visibility       Visibility    @default(PUBLIC)
    metadata         Json?
    publishedAt      DateTime?
    createdAt        DateTime      @default(now())
    updatedAt        DateTime?     @updatedAt

    // inventory
    inventory         Int @default(0) // simple inventory count
    lowStockThreshold Int @default(5) // optional, for alerts

    // images
    images Upload[]

    // SEO
    metaTitle       String?
    metaDescription String?
    metaKeywords    Json?
    canonicalUrl    String?
    ogTitle         String?
    ogDescription   String?
    ogImageId       String?
    twitterCard     TwitterCard?
    structuredData  Json?
    locale          String?
    translations    Json?

    // relations
    categories ProductCategory[]
    tags       ProductTag[]

    createdById String?
    createdBy   User?   @relation("ProductUploader", fields: [createdById], references: [id])

    publishedById String?
    publishedBy   User?   @relation("ProductPublisher", fields: [publishedById], references: [id])

    favouritedBy Favourite[] // reverse relation via Favourite model

    // Offers & coupons join tables
    productOffers  ProductOffer[]
    couponProducts CouponProduct[]

    // social proof
    averageRating Float?      @default(0)
    reviewCount   Int?        @default(0) // reviewCount (by visits and reviews of that product will be counted for each products to check out )
    featured      Boolean     @default(false)
    cartItems     CartItem[]
    orderItems    OrderItem[]
    reviews       Review[]
    stockLogs     StockLog[]
    waitlists     Waitlist[]
    visits        Visit[]

    @@index([name])
    @@index([status, visibility])
}

// categories & tags (you already had these; keep as-is)
model Category {
    id          String            @id @default(cuid())
    name        String
    slug        String            @unique
    description String?
    products    ProductCategory[]
    createdAt   DateTime          @default(now())
    updatedAt   DateTime?         @updatedAt
}

model ProductCategory {
    id         String @id @default(cuid())
    productId  String
    categoryId String

    product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
    category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

    @@unique([productId, categoryId])
    @@index([categoryId])
}

model Tag {
    id       String       @id @default(cuid())
    name     String
    slug     String       @unique
    products ProductTag[]
}

model ProductTag {
    id        String @id @default(cuid())
    productId String
    tagId     String

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
    tag     Tag     @relation(fields: [tagId], references: [id], onDelete: Cascade)

    @@unique([productId, tagId])
    @@index([tagId])
}

// ---------- Cart ----------
model Cart {
    id        String    @id @default(cuid())
    userId    String
    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    expiresAt DateTime? // optional

    user  User       @relation(fields: [userId], references: [id], onDelete: Cascade)
    items CartItem[]

    @@index([userId])
}

model CartItem {
    id        String    @id @default(cuid())
    cartId    String
    productId String
    price     Decimal? // price at time of add (snapshot)
    quantity  Int       @default(1)
    createdAt DateTime  @default(now())
    updatedAt DateTime? @updatedAt

    cart    Cart    @relation(fields: [cartId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id])

    @@index([cartId])
    @@index([productId])
}

model Brand {
    id          String  @id @default(cuid())
    name        String  @unique
    logo        String?
    description String?
    metadata    Json?

    // FK
    createdById String
    createdBy   User   @relation("BrandCreatedBy", fields: [createdById], references: [id])

    upload        Upload?
    publishedById String?
    publishedBy   User?   @relation("BrandPublisher", fields: [publishedById], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

// ---------- Orders & payments ----------
model Order {
    id             String        @id @default(cuid())
    userId         String
    addressId      String // shipping address snapshot ref
    orderNumber    String        @unique // e.g. ORD-20251216-0001
    status         OrderStatus   @default(CREATED)
    paymentMethod  PaymentMethod
    paymentStatus  PaymentStatus @default(PENDING)
    subTotal       Decimal
    shippingFee    Decimal       @default(0)
    discountAmount Decimal       @default(0)
    taxAmount      Decimal       @default(0)
    totalAmount    Decimal
    notes          String?
    createdAt      DateTime      @default(now())
    updatedAt      DateTime?     @updatedAt

    user              User               @relation(fields: [userId], references: [id], onDelete: Cascade)
    address           Address            @relation(fields: [addressId], references: [id])
    items             OrderItem[]
    payment           Payment?
    logs              OrderLog[]
    couponRedemptions CouponRedemption[]

    @@index([userId])
    @@index([status])
}

model OrderItem {
    id        String   @id @default(cuid())
    orderId   String
    productId String
    sku       String?
    name      String // snapshot of product name
    price     Decimal // snapshot unit price
    quantity  Int
    lineTotal Decimal // price * quantity (after item discount if any)
    createdAt DateTime @default(now())

    order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id])

    @@index([orderId])
    @@index([productId])
}

model Payment {
    id           String        @id @default(cuid())
    orderId      String        @unique
    provider     String // e.g. "JazzCash"
    providerTxId String? // transaction id from provider
    method       PaymentMethod
    amount       Decimal
    status       PaymentStatus @default(PENDING)
    metadata     Json?
    createdAt    DateTime      @default(now())
    updatedAt    DateTime?     @updatedAt

    order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

    @@index([orderId])
    @@index([providerTxId])
}

// Order logs for admin actions & statuses
model OrderLog {
    id         String       @id @default(cuid())
    orderId    String
    actorId    String? // user/admin who made the change
    message    String
    fromStatus OrderStatus?
    toStatus   OrderStatus?
    createdAt  DateTime     @default(now())

    order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
    actor User? @relation(fields: [actorId], references: [id])
}

// ---------------------------------------------------
//                   Utility Tables
// ---------------------------------------------------
model Upload {
    id         String   @id @default(cuid())
    productId  String?
    brandId    String?  @unique
    path       String // path or URL
    fileName   String
    mimeType   String?
    size       Int?
    width      Int?
    height     Int?
    altText    String?
    caption    String?
    order      Int      @default(0)
    isPrimary  Boolean  @default(false)
    uploadedAt DateTime @default(now())

    product Product? @relation(fields: [productId], references: [id], onDelete: Cascade)
    brand   Brand?   @relation(fields: [brandId], references: [id])

    @@index([productId, order])
    @@index([isPrimary])
}

// ---------- Coupons & Offers ----------
model Coupon {
    id             String     @id @default(cuid())
    code           String     @unique
    description    String?
    type           CouponType
    value          Decimal // percent (0-100) for PERCENT or amount for FIXED
    isActive       Boolean    @default(true)
    startsAt       DateTime?
    endsAt         DateTime?
    usageLimit     Int? // total uses across users
    perUserLimit   Int? // uses per user
    firstOrderOnly Boolean    @default(false)
    minOrderValue  Decimal?
    createdAt      DateTime   @default(now())
    updatedAt      DateTime?  @updatedAt

    // optional relation to specific products (if not present, coupon is global)
    products    CouponProduct[]
    redemptions CouponRedemption[]

    @@index([code])
}

model CouponProduct {
    id        String @id @default(cuid())
    couponId  String
    productId String

    coupon  Coupon  @relation(fields: [couponId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@unique([couponId, productId])
    @@index([productId])
}

model CouponRedemption {
    id       String   @id @default(cuid())
    couponId String
    userId   String
    orderId  String?
    usedAt   DateTime @default(now())

    coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)
    user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
    order  Order? @relation(fields: [orderId], references: [id])

    @@index([couponId])
    @@index([userId])
}

// Product-level direct offers/promotions
model Offer {
    id           String     @id @default(cuid())
    title        String
    description  String?
    type         CouponType
    value        Decimal
    startsAt     DateTime?
    endsAt       DateTime?
    isActive     Boolean    @default(true)
    appliesToAll Boolean    @default(false) // if true apply to all products
    createdAt    DateTime   @default(now())
    updatedAt    DateTime?  @updatedAt

    productOffers ProductOffer[]
}

model ProductOffer {
    id        String @id @default(cuid())
    productId String
    offerId   String

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
    offer   Offer   @relation(fields: [offerId], references: [id], onDelete: Cascade)

    @@unique([productId, offerId])
    @@index([offerId])
}

// ---------- Reviews ----------
model Review {
    id        String    @id @default(cuid())
    userId    String
    productId String
    rating    Int // 1-5
    title     String?
    comment   String?
    createdAt DateTime  @default(now())
    updatedAt DateTime? @updatedAt

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@index([productId])
    @@index([userId])
}

// ---------- Inventory & Waitlist ----------
model StockLog {
    id        String   @id @default(cuid())
    productId String
    change    Int // positive for increase, negative for decrease
    reason    String? // e.g. "order", "admin_adjust", "restock"
    createdAt DateTime @default(now())

    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@index([productId])
}

model Waitlist {
    id         String    @id @default(cuid())
    userId     String
    productId  String
    createdAt  DateTime  @default(now())
    notifiedAt DateTime?

    user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
    product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

    @@unique([userId, productId])
    @@index([productId])
}

// ---------- Admin & Audit ----------
model AuditLog {
    id        String   @id @default(cuid())
    actorId   String? // optional: which admin/user made change
    entity    String // e.g. "Product", "Order", "User"
    entityId  String
    action    String // "CREATE", "UPDATE", "DELETE", "STATUS_CHANGE"
    details   Json?
    createdAt DateTime @default(now())

    actor User? @relation(fields: [actorId], references: [id])

    @@index([entity, entityId])
}

// ---------- Light analytics events (visits, leads) ----------
model Visit {
    id        String   @id @default(cuid())
    userId    String?
    productId String?
    path      String
    referrer  String?
    ip        String?
    userAgent String?
    country   String?
    city      String?
    time      DateTime @default(now())
    metadata  Json     @default(dbgenerated())
    user      User?    @relation(fields: [userId], references: [id])
    product   Product? @relation(fields: [productId], references: [id])

    @@index([userId])
}
